{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ルート検索 -田んぼ選択-</title>
{#    leaflet#}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    {#    leatlet/draw#}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.9/leaflet.draw-src.js"></script>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.9/leaflet.draw-src.css' />

    {#    bingmap#}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-plugins/3.3.1/layer/tile/Bing.js"></script>
    <script type="text/javascript" src="https://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0&mkt=ja-JP"></script>

    {#    jquery#}
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

    {#    searchEngin#}
    <link rel="stylesheet" href={% static 'rection1/search_box.css' %} />
    <link rel="stylesheet" href={% static 'rection1/OSMGeocoder.css' %} />
    <script src="{% static 'rection1/OSMGeocoder.js' %}"></script>

    <style>
      #mapid { height: 750px; z-index: 1}
    </style>

    {# 操作説明 #}
    <link rel="stylesheet" href="{% static 'systemdesign/css/lightbox.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js" type="text/javascript"></script>

    <link rel="icon" href="http://saetl.net/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" type="img/x-icon" href="http://saetl.net/favicon.ico">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Berkshire+Swash|Lobster" rel="stylesheet" type="text/css"><!--googlewebフォント-->

    <link rel="stylesheet" href="{% static 'systemdesign/css/responsive_menu.css' %}"><!--レスポンシブメニュー-->
    <link rel="stylesheet" href="{% static 'systemdesign/css/css.css' %}">
    <link rel="stylesheet" href="{% static 'systemdesign/css/font.css' %}">
    <link rel="stylesheet" href="{% static 'systemdesign/css/button.css' %}">

    <script src="{% static 'systemdesign/js/radio_button.js' %}"></script>
    <script src="{% static 'systemdesign/js/button_control.js' %}"></script>
</head>
<body onload="init()">
<!--<header>-->
<h1 class="h1title">
    <a href="{% url 'index' %}" title="メニュー画面へ移動します" style="padding: 0 0.5em">田んぼルート検索</a>
    <a href="mailto:address"><img src="{% static 'systemdesign/images/mail.png' %}" class="tel-fixed"></a>
</h1>
<!--</header>-->
<div class="background">
    <div class="side"></div>
<article class="backsayuu">
    <div class="contents-have">
        <h1>田んぼ選択<span>-ルート検索-</span></h1>
    </div>
    <br>

{#    <form action="{% url 'kikai_info' %}" method="post">#}
        <h3>? 登録した田んぼに植えますか ?</h3>

        <div class="hidden_box">
            <div class="hidden_box1">
                <input type="checkbox" id="label1" name="group" onclick="clickBtn1()">
                <label for="label1"><h4>登録した田んぼに植える</h4></label>
                <div class="hidden_show1">
                    <h4>↓ 登録した田んぼを表示中です ↓</h4>
                    {% for paddy in paddy_info %}
                        <label> <input type="radio" name="paddy" id="paddy" value="{{ paddy.paddy_name }}">{{ paddy.paddy_name }}</label><br>
                    {% endfor %}
{#                    1:<input type="radio" name="paddy" id="tanbo1" onclick="clickBtn1()"><br>#}
{#                    2:<input type="radio" name="paddy" id="tanbo2" onclick="clickBtn1()"><br>#}
{#                    3:<input type="radio" name="tanbo" id="tanbo3" onclick="clickBtn1()"><br>#}
{#                    4:<input type="radio" name="tanbo" id="tanbo4" onclick="clickBtn1()"><br>#}
{#                    {% for paddy in paddy %}#}
{#		                <input type="radio" name="{{ paddy.id }}" id="tanbo1" onclick="clickBtn1()"><br>#}
{#                    {% endfor %}#}
                </div>
                <!-- hidden_show1 -->
            </div>
            <!-- hidden_box1 -->
        </div>
        <!-- hidden_box -->
        <br>
        <h3>? 新しい田んぼに植えますか ?</h3>

        <div class="hidden_box">
            <div class="hidden_box2">
                <input type="checkbox" id="label2" name="group" onclick="clickBtn2()">
                <label for="label2"><h4>新しい田んぼに植える</h4></label>
                <div class="hidden_show2">

                    <h4>マップを使用して<br>情報を取得してください</h4>
                    田んぼ名：<input type="text" name="paddy_name" id="paddy_name" class="validate[required]" data-prompt-position="topLeft">
                    <div id="mapid"></div>
                    <div id="message"></div>
{#                    <input type="button" id="register" value="- 登録する -" class="button-default">#}
                    <script>

                        let map;
                        let position = [];
                        let location_json = [];
                        let start_end_point = [];
                        let start_end_point_json = [];
                        let name;

                        function init() {

                            map = L.map('mapid', {
                                center: [34.38580436023255, 132.454444169998],
                                zoom: 18,
                                zoomControl: false
                            });

                            L.control.zoom({
                                position: 'bottomright',
                                zoomInTitle: 'ズームイン',
                                zoomOutTitle: 'ズームアウト'
                            }).addTo(map);

                            //ベースMap(どれか１つ）
                            const bingmaps = new L.BingLayer("AjLokX7PlXoy5aDmEGEOXwr1_DY1J4v71vsumvhDqWdFFqb6SxBKmlmNoYERKpB2", {
                                imagerySet: 'AerialWithLabelsOnDemand',
                                culture: 'ja',
                                maxZoom: 19
                            });

                            bingmaps.addTo(map);

                            // Control OSM Geocoder
                            const option = {
                                position: 'topleft', // topright, topleft, bottomright, bottomleft
                                text: '検索',
                                placeholder: 'キーワード',
                                collapsed: false
                            };

                            const osmGeocoder = new L.Control.OSMGeocoder(option);
                            map.addControl(osmGeocoder);


                            const MyPolygonMarker = L.Icon.extend({
                                options: {
                                    iconAnchor: new L.Point(25, 50),
                                    iconSize: new L.Point(50, 50),
                                    iconUrl: '{% static 'rection1/pingicon.png' %}',
                                    iconRetinaUrl: '{% static 'rection1/pingicon.png' %}'
                                },
                            });

                            const MyCustomMarker = L.Marker.include({
                                paddyStartPosition: false,
                                paddyEndPosition: false,

                                bindOpenTooltip: function (){
                                    if(this.paddyStartPosition && !this.paddyEndPosition) {
                                        this.bindTooltip("入口", {permanent: true}).openTooltip();
                                    }else if(!this.paddyStartPosition && this.paddyEndPosition) {
                                        this.bindTooltip("出口", {permanent: true}).openTooltip();
                                    }
                                }
                            });

                            const MyCustomMarkerFeatureGroup = L.FeatureGroup.include({
                                startPosition: false,
                                endPosition: false,

                                setPosition: function (newLayer) {
                                    if (newLayer instanceof MyCustomMarker) {
                                        //始点が設定されていなかったとき
                                        if (!this.startPosition) {
                                            newLayer.paddyStartPosition = true;
                                            this.startPosition = true;
                                            newLayer.bindOpenTooltip();
                                            return true;
                                            //始点が設定されていて終点が設定されていなかったとき
                                        } else if (!this.endPosition) {
                                            newLayer.paddyEndPosition = true;
                                            this.endPosition = true;
                                            newLayer.bindOpenTooltip();
                                            return true;
                                        }
                                    }
                                    return false;
                                },

                                releasePosition: function (layer){
                                    if(layer instanceof MyCustomMarker){
                                        if(layer.paddyStartPosition){
                                            this.startPosition = false;
                                        }else if (layer.paddyEndPosition){
                                            this.endPosition = false;
                                        }
                                    }
                                },

                                addLayerSetPosition: function(newLayer) {
                                    if(newLayer instanceof  MyCustomMarker) {
                                        if (this.startPosition) {
                                            return false;
                                        } else {
                                            this.setPosition(newLayer);
                                            this.addLayer(newLayer);
                                        }
                                    }
                                },

                                removeLayerReleasePosition: function(layer){
                                    if(layer instanceof  MyCustomMarker){
                                        this.releasePosition(layer);
                                        this.removeLayer(layer);
                                    }

                                }
                            })

                            // 図形をまとめるためのオブジェクト
                            const drawnItems = new L.FeatureGroup().addTo(map);
                            const markerGroup = new L.FeatureGroup().addTo(map);
                            {#const markerItems = new MyCustomMarkerFeatureGroup().addTo(map);#}

                            const options = {
                                position: 'topright',
                                draw: {
                                    polyline: false,
                                    polygon: {
                                        allowIntersection: false, // Restricts shapes to simple polygons
                                        drawError: {
                                            color: '#e1e100', // Color the shape will turn when intersects
                                            message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                                        },
                                        shapeOptions: {
                                            color: '#0000FF'
                                        },
                                        icon: new MyPolygonMarker()
                                    },
                                    circle: false,
                                    rectangle: false,
                                    marker: false
                                },
                                edit: {
                                    featureGroup: drawnItems, //REQUIRED!!
                                },
                            };

                            L.drawLocal = {
                                draw: {
                                    toolbar: {
                                        actions: {
                                            title: 'Cancel drawing',
                                            text: 'キャンセル'
                                        },
                                        finish: {
                                            title: 'Finish drawing',
                                            text: '描画終了'
                                        },
                                        undo: {
                                            title: 'Delete last point drawn',
                                            text: '最後につけた点を削除する'
                                        },
                                        buttons: {
                                            polygon: '多角形の画像を描画',
                                            marker: '始点と終点を決めます',
                                        }
                                    },
                                    handlers: {
                                        circle: {
                                            tooltip: {
                                                start: 'Click and drag to draw circle.'
                                            },
                                            radius: 'Radius'
                                        },
                                        marker: {
                                            tooltip: {
                                                start: '始点と終点を設定'
                                            }
                                        },
                                        polygon: {
                                            tooltip: {
                                                start: 'クリックで始点を決定します',
                                                cont: 'クリックで次の点を決定します',
                                                end: 'クリックで終点を始点とつなぎ描画は終了します'
                                            }
                                        },
                                        polyline: {
                                            error: '<strong>Error:</strong> shape edges cannot cross!',
                                            tooltip: {
                                                start: 'Click to start drawing line.',
                                                cont: 'Click to continue drawing line.',
                                                end: 'Click last point to finish line.'
                                            }
                                        },
                                        rectangle: {
                                            tooltip: {
                                                start: 'Click and drag to draw rectangle.'
                                            }
                                        },
                                        simpleshape: {
                                            tooltip: {
                                                end: 'Release mouse to finish drawing.'
                                            }
                                        }
                                    },
                                },
                                edit: {
                                    toolbar: {
                                        actions: {
                                            save: {
                                                title: 'Save changes.',
                                                text: '変更を保存'
                                            },
                                            cancel: {
                                                title: 'Cancel editing, discards all changes.',
                                                text: '変更を破棄'
                                            }
                                        },
                                        buttons: {
                                            edit: '編集',
                                            editDisabled: 'No layers to edit.',
                                            remove: '削除',
                                            removeDisabled: 'No layers to delete.'
                                        }
                                    },
                                    handlers: {
                                        edit: {
                                            tooltip: {
                                                text: '描画した図の頂点ををクリックすることで編集できます',
                                                subtext: 'Click cancel to undo changes.'
                                            }
                                        },
                                        remove: {
                                            tooltip: {
                                                text: '描画した図を消去する'
                                            }
                                        }
                                    }
                                }
                            };

                            // 図形を描くためのコントローラ
                            // 位置のデフォルトは左上ですが、右上に指定を変えています。
                            const drawControl = new L.Control.Draw(options).addTo(map);
                            map.addControl(drawControl);

                            //Drawレイヤーを追加したときにトリガーされる
                            map.on(L.Draw.Event.CREATED, function (e) {
                                const markerItems = new MyCustomMarkerFeatureGroup().addTo(map);
                                const type = e.layerType, layer = e.layer;
                                //typeがポリゴンなら
                                if (type === 'polygon') {
                                    //ポリゴン内にツールチップ作成
                                    layer.bindTooltip("クリックして出入口を指定してください", {sticky:true}).openTooltip();
                                    const _coords = layer.getLatLngs()[0];
                                    layer.on("click", function (e) {
                                        map.fitBounds(layer.getBounds());
                                        const marker = new MyCustomMarker(
                                            e.latlng,
                                            {
                                                draggable: true,
                                                maxBounds: layer.getLatLngs()
                                            }
                                        ).on("click", function () {
                                                //Marker削除の処理
                                                markerItems.removeLayerReleasePosition(this);
                                            }
                                        ).on("dragend", function () {
                                            //ポリゴンのリストを作成
                                            const polygonInnerLatLngList = [];
                                            //ポリゴンをリスト化する。
                                            $.each(_coords, function (ind, val) {
                                                polygonInnerLatLngList.push([val.lat, val.lng]);
                                            });
                                            //描画可能範囲を指定
                                            if (!isInsideByCrossingNumberAlgorithm([this.getLatLng().lat, this.getLatLng().lng], polygonInnerLatLngList)) {
                                                markerItems.removeLayerReleasePosition(this);
                                            }
                                        });
                                        markerItems.addLayerSetPosition(marker);
                                    });
                                    map.fitBounds(layer.getBounds());
                                    drawnItems.addLayer(e.layer);
                                    markerGroup.addLayer(markerItems)
                                }
                            });

                            map.on("draw:deleted", function (e) {
                                const layers = e.layers;
                                layers.eachLayer(function (layer) {
                                    if (layer instanceof L.Polygon) {
                                        position = [];
                                        start_end_point = [];
                                        location_json = JSON.stringify(position);
                                        start_end_point_json = JSON.stringify(start_end_point);
                                    }
                                });
                            });

                            //多角形の中にマーカがあるのかどうかを判定するアルゴリズム
                            function isInsideByCrossingNumberAlgorithm(point, polygon) {
                                const x = point[0];
                                const y = point[1];

                                let crossCount = 0;
                                for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                                    // 多角形を成す辺を全て調査する
                                    // 現在の index の多角形の点X, Y
                                    const polCX = polygon[i][0];
                                    const polCY = polygon[i][1];
                                    // 次の index の多角形の点X, Y
                                    const polNX = polygon[j][0];
                                    const polNY = polygon[j][1];

                                    if (polCY > y === polNY > y) {
                                        // 点が辺の完全に上 or 完全に下ならば. ノーカウントでループ続行
                                        continue;
                                    }

                                    // 辺が点pと同じ高さになる位置を特定し、その時のxの値と点pのxの値を比較する
                                    // 同じ高さになる時の辺の割合 = (点Y - 始点Y座標)) / 辺のY軸長さ
                                    const vt = (y - polCY) / (polNY - polCY);
                                    // 点のX座標 < 辺のX軸長さ * 同じ高さになる時の辺の割合 + 始点X座標
                                    if (x < (polNX - polCX) * vt + polCX) {
                                        crossCount++;
                                    }
                                }
                                return crossCount % 2 === 1;
                            }

                            $('#route_search').on('click', function(){
                                name = document.getElementById('paddy_name').value;
                                location_json = [];
                                start_end_point_json = [];
                                position = [];
                                start_end_point = [];
                                let location_info = 0;
                                let start_end_position_info = false;
                                drawnItems.eachLayer(function (layer) {
                                    if (layer instanceof L.Polygon) {
                                        const _coords = layer.getLatLngs()[0];
                                        $.each(_coords, function (ind, val) {
                                            const location = {};
                                            location.position = ind;
                                            location.y = val.lat;
                                            location.x = val.lng;
                                            position.push(location);
                                        });
                                        const paddyFields = {};
                                        paddyFields.paddyFields = position;
                                        location_json = JSON.stringify(paddyFields);
                                        location_info++;
                                    }
                                });

                                markerGroup.eachLayer(function (layer){
                                    if (layer instanceof MyCustomMarkerFeatureGroup) {
                                        layer.eachLayer(function (layer) {
                                            start_end_position_info = true;
                                            if (layer.paddyStartPosition) {
                                                const point = {};
                                                const Position = {};
                                                point.position = "start";
                                                point.y = layer.getLatLng().lat;
                                                point.x = layer.getLatLng().lng;
                                                start_end_point.push(point);
                                                Position.startEndPosition = start_end_point;
                                                start_end_point_json = JSON.stringify(Position);
                                            } else if (layer.paddyEndPosition) {
                                                const point = {};
                                                const Position = {};
                                                point.position = "end";
                                                point.y = layer.getLatLng().lat;
                                                point.x = layer.getLatLng().lng;
                                                start_end_point.push(point);
                                                Position.startEndPosition = start_end_point;
                                                start_end_point_json = JSON.stringify(Position);
                                            }
                                        });
                                    }
                                });
                                if($("input[name='paddy']:checked").val() && location_info !== 0) {
                                    alert("田んぼ情報は登録済みまたは新規登録のどちらかのみ選択、記入してください。")
                                    return;
                                }else if ($("input[name='paddy']:checked").val()){
                                    $.ajax({
                                        url: "{% url 'tanbo_search' %}",
                                        method: "GET",
                                        // プレーンテキストを受信（他にはhtml、xml、script、json、jsonp等）
                                        dataType: 'text',
                                        // リクエストパラメータ「?param1=いろはに&param2=ほへと&param3=ちりぬるを」
                                        data: {
                                            paddy_name: $("input[name='paddy']:checked").val(),
                                            {#location_start_end_point_data: start_end_point_json,#}
                                            {#paddy_name: name#}
                                        },
                                    }).done(function(response) {
                                        // 通信成功時の処理を記述
                                        location_json = response.location_json_data
                                        start_end_point_json = response.location_start_end_point_data

                                        $('#resultGET').text('GET処理成功：' + data + '.');
                                    }).fail(function() {
                                        // 通信失敗時の処理を記述
                                        alert('失敗')
                                        $('#resultGET').text('GET処理失敗.');
                                    });
                                }else if (location_info !== 0) {
                                    if (location_info === 0) {
                                        alert("田んぼの情報を登録してください。")
                                        return;
                                    } else if (location_info > 1) {
                                        alert("田んぼを複数登録することはできません。\n一つのみ登録可能です")
                                        return;
                                    }
                                    if (!start_end_position_info) {
                                        alert("出入り口の情報が登録されていません。")
                                        return;
                                    }
                                }
                                $('#resultGET').text('通信中...');
                                // Ajax通信を開始
                                $.ajax({
                                    url: "{% url 'position' %}",
                                    method: "GET",
                                    async: false,
                                    // プレーンテキストを受信（他にはhtml、xml、script、json、jsonp等）
                                    dataType: 'text',
                                    // リクエストパラメータ「?param1=いろはに&param2=ほへと&param3=ちりぬるを」
                                    data: {
                                        location_json_data: location_json,
                                        location_start_end_point_data: start_end_point_json,
                                        paddy_name: name
                                    },
                                }).done(function(data) {
                                    // 通信成功時の処理を記述
                                    document.location.href = "{% url 'route_search' %}"
                                    $('#resultGET').text('GET処理成功：' + data + '.');
                                }).fail(function() {
                                    // 通信失敗時の処理を記述
                                    alert('失敗')
                                    $('#resultGET').text('GET処理失敗.');
                                });
                            });
                        }
                    </script>
                    <table class="ta">
                        <tr>
                            <th>
                                使用例
                            </th>
                            <td>
                                <!--                <ul class="slider">-->
                                <a href="{% static 'systemdesign/images/choice.png' %}" data-lightbox="group"><img src="{% static 'systemdesign/images/choice.png' %}" alt="" width="30%"></a>
                                <a href="{% static 'systemdesign/images/choice2.png' %}" data-lightbox="group"><img src="{% static 'systemdesign/images/choice2.png' %}" alt="" width="30%"></a>
                                <a href="{% static 'systemdesign/images/choice3.png' %}" data-lightbox="group"><img src="{% static 'systemdesign/images/choice3.png' %}" alt="" width="30%"></a>
                                <a href="{% static 'systemdesign/images/choice4.png' %}" data-lightbox="group"><img src="{% static 'systemdesign/images/choice4.png' %}" alt="" width="30%"></a>
                                <a href="{% static 'systemdesign/images/choice5.png' %}" data-lightbox="group"><img src="{% static 'systemdesign/images/choice5.png' %}" alt="" width="30%"></a>
                                <!--                    &lt;!&ndash;/slider&ndash;&gt;</ul>-->
                            </td>
                        </tr>
                    </table>
                    <br><br><br>
                </div>
                <!-- hidden_show2 -->
            </div>
            <!-- hidden_box2-->
        </div>
        <!-- hidden_box -->
{#    </form>#}

    <br><br>
{#    <div class="reset button-bg from-left">#}
        <input type="button" id="route_search" value=" ルート検索　開始 " class="button-default">
{#        <a href="{% url 'kikai_info' %}" class="button-default"> 植え方選択 </a><br><br>#}
    <a href="{% url 'kikai_info' %}" class="fas fa-chevron-circle-left"> ひとつ前に戻る </a>

{#    </div>#}
</article>
    <div class="side"></div>
</div>
<a href="tel:000-0000-0000">
    <img class="tel-fixed-phone" src="{% static 'systemdesign/images/denwa.png' %}"></a>

</body>
</html>